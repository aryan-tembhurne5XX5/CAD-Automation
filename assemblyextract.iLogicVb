Imports Inventor
Imports System.Text
Imports System.IO

Sub Main()

    Dim asmDoc As AssemblyDocument = ThisApplication.ActiveDocument
    If asmDoc.DocumentType <> DocumentTypeEnum.kAssemblyDocumentObject Then
        MessageBox.Show("Run this rule in an Assembly (.iam)")
        Exit Sub
    End If

    Dim asmDef As AssemblyComponentDefinition = asmDoc.ComponentDefinition
    Dim sb As New StringBuilder()
    Dim Q As String = Chr(34)

    sb.AppendLine("{")

    '================ Assembly Metadata =================
    sb.AppendLine("  " & Q & "assembly_metadata" & Q & ": {")
    sb.AppendLine("    " & Q & "assembly_name" & Q & ": " & Q & asmDoc.DisplayName & Q & ",")
    sb.AppendLine("    " & Q & "full_path" & Q & ": " & Q & asmDoc.FullFileName & Q & ",")
    sb.AppendLine("    " & Q & "units" & Q & ": " & Q & "mm" & Q & ",")
    sb.AppendLine("    " & Q & "mass_kg" & Q & ": " & asmDef.MassProperties.Mass & ",")
    sb.AppendLine("    " & Q & "created_on" & Q & ": " & Q & GetProp(asmDoc, "Design Tracking Properties", "Creation Time") & Q & ",")
    sb.AppendLine("    " & Q & "author" & Q & ": " & Q & GetProp(asmDoc, "Summary Information", "Author") & Q)
    sb.AppendLine("  },")

    '================ Root Coordinate System =================
    sb.AppendLine("  " & Q & "root_coordinate_system" & Q & ": {")
    sb.AppendLine("    " & Q & "origin_mm" & Q & ": { ""x"":0,""y"":0,""z"":0 },")
    sb.AppendLine("    " & Q & "x_axis" & Q & ": { ""x"":1,""y"":0,""z"":0 },")
    sb.AppendLine("    " & Q & "y_axis" & Q & ": { ""x"":0,""y"":1,""z"":0 },")
    sb.AppendLine("    " & Q & "z_axis" & Q & ": { ""x"":0,""y"":0,""z"":1 }")
    sb.AppendLine("  },")

    '================ Components =================
    sb.AppendLine("  " & Q & "components" & Q & ": [")

    Dim occs = asmDef.Occurrences.AllLeafOccurrences
    Dim idx As Integer = 0
    Dim compJson As New List(Of String)
    Dim fasteners As New List(Of ComponentOccurrence)

    For Each occ As ComponentOccurrence In occs

        Dim m As Matrix = occ.Transformation

        Dim partNum As String = GetProp(occ.Definition.Document, "Design Tracking Properties", "Part Number")
        If partNum = "" Then partNum = occ.Name

        Dim compType As String = "Part"
        If occ.DefinitionDocumentType = DocumentTypeEnum.kAssemblyDocumentObject Then compType = "Subassembly"
        If IsFastener(occ) Then
            compType = "Fastener"
            fasteners.Add(occ)
        End If

        Dim patParent As String = "null"
        If occ.IsPatternElement Then
            Try
                patParent = Q & occ.PatternElement.Parent.Name & Q
            Catch
            End Try
        End If

        Dim s As New StringBuilder()
        s.AppendLine("    {")
        s.AppendLine("      ""occurrence_name"": """ & occ.Name & """,")
        s.AppendLine("      ""part_number"": """ & partNum & """,")
        s.AppendLine("      ""file_name"": """ & occ.Definition.Document.DisplayName & """,")

        s.AppendLine("      ""transform"": {")
        s.AppendLine("        ""translation_mm"": { ""x"":" & (m.Cell(1,4)*10) & ", ""y"":" & (m.Cell(2,4)*10) & ", ""z"":" & (m.Cell(3,4)*10) & " },")
        s.AppendLine("        ""rotation_matrix"": [")
        s.AppendLine("          [" & m.Cell(1,1) & "," & m.Cell(1,2) & "," & m.Cell(1,3) & "],")
        s.AppendLine("          [" & m.Cell(2,1) & "," & m.Cell(2,2) & "," & m.Cell(2,3) & "],")
        s.AppendLine("          [" & m.Cell(3,1) & "," & m.Cell(3,2) & "," & m.Cell(3,3) & "]")
        s.AppendLine("        ]")
        s.AppendLine("      },")

        s.AppendLine("      ""grounded"": " & LCase(CStr(occ.Grounded)) & ",")
        s.AppendLine("      ""suppressed"": " & LCase(CStr(occ.Suppressed)) & ",")
        s.AppendLine("      ""instance_index"": " & idx & ",")
        s.AppendLine("      ""pattern_parent"": " & patParent & ",")
        s.AppendLine("      ""component_type"": """ & compType & """,")
        s.AppendLine("      ""confidence"": 1.0")
        s.Append("    }")

        compJson.Add(s.ToString())
        idx += 1
    Next

    sb.AppendLine(String.Join("," & vbCrLf, compJson))
    sb.AppendLine("  ],")

    '================ Constraints =================
    sb.AppendLine("  ""constraints"": [")

    Dim consJson As New List(Of String)

    For Each c As AssemblyConstraint In asmDef.Constraints
        If c.Suppressed Then Continue For

        Dim cType As String = "Other"
        If TypeOf c Is MateConstraint Then cType = "Mate"
        If TypeOf c Is FlushConstraint Then cType = "Flush"
        If TypeOf c Is InsertConstraint Then cType = "Insert"
        If TypeOf c Is AngleConstraint Then cType = "Angle"

        Dim s As New StringBuilder()
        s.AppendLine("    {")
        s.AppendLine("      ""constraint_id"": """ & c.Name & """,")
        s.AppendLine("      ""constraint_type"": """ & cType & """,")

        s.AppendLine("      ""component_1"": { ""occurrence"": """ & c.OccurrenceOne.Name & """, ""entity_type"": ""Unknown"", ""connection_point_id"": null },")
        s.AppendLine("      ""component_2"": { ""occurrence"": """ & c.OccurrenceTwo.Name & """, ""entity_type"": ""Unknown"", ""connection_point_id"": null },")

        s.AppendLine("      ""parameters"": { ""offset_mm"": null, ""angle_deg"": null, ""flip"": false },")
        s.AppendLine("      ""derived"": false,")
        s.AppendLine("      ""confidence"": 1.0")
        s.Append("    }")

        consJson.Add(s.ToString())
    Next

    sb.AppendLine(String.Join("," & vbCrLf, consJson))
    sb.AppendLine("  ],")

    '================ Assembly Graph =================
    sb.AppendLine("  ""assembly_graph"": {")
    sb.AppendLine("    ""nodes"": [")

    Dim nodes As New List(Of String)
    For Each occ As ComponentOccurrence In occs
        Dim t As String = If(IsFastener(occ), "Fastener", "Part")
        nodes.Add("      { ""occurrence"": """ & occ.Name & """, ""type"": """ & t & """ }")
    Next

    sb.AppendLine(String.Join("," & vbCrLf, nodes))
    sb.AppendLine("    ],")

    sb.AppendLine("    ""edges"": [")

    Dim edges As New List(Of String)
    For Each c As AssemblyConstraint In asmDef.Constraints
        Try
            edges.Add("      { ""from"": """ & c.OccurrenceOne.Name & """, ""to"": """ & c.OccurrenceTwo.Name & """, ""relation"": ""Constrained"" }")
        Catch
        End Try
    Next

    sb.AppendLine(String.Join("," & vbCrLf, edges))
    sb.AppendLine("    ]")
    sb.AppendLine("  }")

    sb.AppendLine("}")

    Dim outPath = Path.ChangeExtension(asmDoc.FullFileName, ".json")
    File.WriteAllText(outPath, sb.ToString())
    MessageBox.Show("Upgraded assembly JSON exported")

End Sub

Function IsFastener(oOcc As ComponentOccurrence) As Boolean
    Try
        If oOcc.Definition.IsContentMember Then Return True
        Dim n = oOcc.Name.ToUpper()
        If n.Contains("BOLT") Or n.Contains("SCREW") Or n.Contains("ISO") Or n.Contains("DIN") Then Return True
    Catch
    End Try
    Return False
End Function

Function GetProp(doc As Document, setName As String, propName As String) As String
    Try
        Return doc.PropertySets.Item(setName).Item(propName).Value.ToString()
    Catch
        Return ""
    End Try
End Function