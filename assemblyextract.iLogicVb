Sub Main()

    Dim asmDoc As Inventor.AssemblyDocument
    asmDoc = ThisApplication.ActiveDocument

    If asmDoc.DocumentType <> Inventor.DocumentTypeEnum.kAssemblyDocumentObject Then
        MessageBox.Show("Run this rule in an Assembly (.iam)")
        Exit Sub
    End If

    Dim asmDef As Inventor.AssemblyComponentDefinition
    asmDef = asmDoc.ComponentDefinition

    Dim sb As New System.Text.StringBuilder()
    Dim Q As String = Chr(34)

    sb.AppendLine("{")

    '================ Assembly Metadata =================
    sb.AppendLine("  " & Q & "assembly_metadata" & Q & ": {")
    sb.AppendLine("    " & Q & "assembly_name" & Q & ": " & Q & asmDoc.DisplayName & Q & ",")
    sb.AppendLine("    " & Q & "full_path" & Q & ": " & Q & asmDoc.FullFileName & Q & ",")
    sb.AppendLine("    " & Q & "units" & Q & ": " & Q & "mm" & Q & ",")
    sb.AppendLine("    " & Q & "mass_kg" & Q & ": " & asmDef.MassProperties.Mass)
    sb.AppendLine("  },")

    '================ Root Coordinate System =================
    sb.AppendLine("  " & Q & "root_coordinate_system" & Q & ": {")
    sb.AppendLine("    " & Q & "origin_mm" & Q & ": { " & Q & "x" & Q & ": 0, " & Q & "y" & Q & ": 0, " & Q & "z" & Q & ": 0 },")
    sb.AppendLine("    " & Q & "x_axis" & Q & ": { " & Q & "x" & Q & ": 1, " & Q & "y" & Q & ": 0, " & Q & "z" & Q & ": 0 },")
    sb.AppendLine("    " & Q & "y_axis" & Q & ": { " & Q & "x" & Q & ": 0, " & Q & "y" & Q & ": 1, " & Q & "z" & Q & ": 0 },")
    sb.AppendLine("    " & Q & "z_axis" & Q & ": { " & Q & "x" & Q & ": 0, " & Q & "y" & Q & ": 0, " & Q & "z" & Q & ": 1 }")
    sb.AppendLine("  },")

    '================ Components =================
    sb.AppendLine("  " & Q & "components" & Q & ": [")

    Dim idx As Integer = 0

    For Each occ As Inventor.ComponentOccurrence In asmDef.Occurrences

        Dim m As Inventor.Matrix = occ.Transformation

        ' Part Number
        Dim partNumber As String = "unknown"
        Try
            partNumber = occ.Definition.Document.PropertySets _
                .Item("Design Tracking Properties").Item("Part Number").Value
        Catch
        End Try

        sb.AppendLine("    {")
        sb.AppendLine("      " & Q & "occurrence_name" & Q & ": " & Q & occ.Name & Q & ",")
        sb.AppendLine("      " & Q & "file_name" & Q & ": " & Q & occ.Definition.Document.DisplayName & Q & ",")
        sb.AppendLine("      " & Q & "part_number" & Q & ": " & Q & partNumber & Q & ",")

        sb.AppendLine("      " & Q & "transform" & Q & ": {")
        sb.AppendLine("        " & Q & "translation_mm" & Q & ": { " & _
                      Q & "x" & Q & ": " & m.Cell(1,4) & ", " & _
                      Q & "y" & Q & ": " & m.Cell(2,4) & ", " & _
                      Q & "z" & Q & ": " & m.Cell(3,4) & " },")

        sb.AppendLine("        " & Q & "rotation_matrix" & Q & ": [")
        sb.AppendLine("          [" & m.Cell(1,1) & ", " & m.Cell(1,2) & ", " & m.Cell(1,3) & "],")
        sb.AppendLine("          [" & m.Cell(2,1) & ", " & m.Cell(2,2) & ", " & m.Cell(2,3) & "],")
        sb.AppendLine("          [" & m.Cell(3,1) & ", " & m.Cell(3,2) & ", " & m.Cell(3,3) & "]")
        sb.AppendLine("        ]")
        sb.AppendLine("      },")

        sb.AppendLine("      " & Q & "grounded" & Q & ": " & LCase(CStr(occ.Grounded)) & ",")
        sb.AppendLine("      " & Q & "suppressed" & Q & ": " & LCase(CStr(occ.Suppressed)) & ",")
        sb.AppendLine("      " & Q & "instance_index" & Q & ": " & idx)
        sb.Append("    }")

        idx += 1
        If idx < asmDef.Occurrences.Count Then sb.AppendLine(",") Else sb.AppendLine()

    Next

    sb.AppendLine("  ],")

    '================ Constraints =================
    sb.AppendLine("  " & Q & "constraints" & Q & ": [")

    Dim cIdx As Integer = 0
    For Each c As Inventor.AssemblyConstraint In asmDef.Constraints
        sb.AppendLine("    {")
        sb.AppendLine("      " & Q & "constraint_name" & Q & ": " & Q & c.Name & Q & ",")
        sb.AppendLine("      " & Q & "constraint_type" & Q & ": " & Q & c.Type.ToString() & Q)
        sb.Append("    }")
        cIdx += 1
        If cIdx < asmDef.Constraints.Count Then sb.AppendLine(",") Else sb.AppendLine()
    Next

    sb.AppendLine("  ],")

    '================ Patterns =================
    sb.AppendLine("  " & Q & "patterns" & Q & ": [")

    Dim pIdx As Integer = 0
    For Each p As Inventor.OccurrencePattern In asmDef.OccurrencePatterns
        sb.AppendLine("    {")
        sb.AppendLine("      " & Q & "pattern_name" & Q & ": " & Q & p.Name & Q & ",")
        sb.AppendLine("      " & Q & "pattern_type" & Q & ": " & Q & p.Type.ToString() & Q)
        sb.Append("    }")
        pIdx += 1
        If pIdx < asmDef.OccurrencePatterns.Count Then sb.AppendLine(",") Else sb.AppendLine()
    Next

    sb.AppendLine("  ]")

    sb.AppendLine("}")

    Dim outPath As String
    outPath = System.IO.Path.ChangeExtension(asmDoc.FullFileName, ".json")
    System.IO.File.WriteAllText(outPath, sb.ToString())

    MessageBox.Show("Assembly JSON exported successfully")

End Sub
