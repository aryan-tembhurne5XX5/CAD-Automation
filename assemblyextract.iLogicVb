Imports System.IO
Imports System.Text
Imports Inventor
Imports System.Globalization

Sub Main()

    ' ======================================================
    ' 1. DOCUMENT CHECK
    ' ======================================================
    Dim oDoc As Document = ThisDoc.Document
    If oDoc.DocumentType <> DocumentTypeEnum.kAssemblyDocumentObject Then
        MessageBox.Show("Run this rule inside an Assembly (.iam) file.")
        Return
    End If

    Dim oAsmDoc As AssemblyDocument = CType(oDoc, AssemblyDocument)
    Dim oDef As AssemblyComponentDefinition = oAsmDoc.ComponentDefinition
    Dim tg As TransientGeometry = ThisApplication.TransientGeometry

    ' ======================================================
    ' 2. JSON BUILDER
    ' ======================================================
    Dim sb As New StringBuilder()
    sb.AppendLine("{")

    ' ======================================================
    ' 3. ASSEMBLY METADATA
    ' ======================================================
    sb.AppendLine("  ""assembly_metadata"": {")
    sb.AppendLine("    ""assembly_name"": """ & EscapeJson(Path.GetFileNameWithoutExtension(oAsmDoc.FullFileName)) & """,")
    sb.AppendLine("    ""full_path"": """ & EscapeJson(oAsmDoc.FullFileName) & """,")
    sb.AppendLine("    ""units"": ""mm"",")
    sb.AppendLine("    ""mass_kg"": " & F(oDef.MassProperties.Mass))
    sb.AppendLine("  },")

    ' ======================================================
    ' 4. COMPONENTS
    ' ======================================================
    sb.AppendLine("  ""components"": [")
    Dim compJson As New List(Of String)

    For Each occ As ComponentOccurrence In oDef.Occurrences.AllLeafOccurrences

        Dim m As Matrix = occ.Transformation
        Dim t As Vector = m.Translation

        Dim partDoc As Document = occ.Definition.Document
        Dim partNumber As String = GetProp(partDoc, "Design Tracking Properties", "Part Number")

        Dim c As New StringBuilder()
        c.AppendLine("    {")
        c.AppendLine("      ""occurrence"": """ & EscapeJson(occ.Name) & """,")
        c.AppendLine("      ""part_number"": """ & EscapeJson(partNumber) & """,")
        c.AppendLine("      ""file"": """ & EscapeJson(Path.GetFileName(partDoc.FullFileName)) & """,")

        ' Transform
        c.AppendLine("      ""transform"": {")
        c.AppendLine("        ""translation_mm"": { ""x"": " & F(t.X * 10) & ", ""y"": " & F(t.Y * 10) & ", ""z"": " & F(t.Z * 10) & " },")
        c.AppendLine("        ""rotation_matrix"": [")
        c.AppendLine("          [ " & F(m.Cell(1,1)) & ", " & F(m.Cell(1,2)) & ", " & F(m.Cell(1,3)) & " ],")
        c.AppendLine("          [ " & F(m.Cell(2,1)) & ", " & F(m.Cell(2,2)) & ", " & F(m.Cell(2,3)) & " ],")
        c.AppendLine("          [ " & F(m.Cell(3,1)) & ", " & F(m.Cell(3,2)) & ", " & F(m.Cell(3,3)) & " ]")
        c.AppendLine("        ]")
        c.AppendLine("      },")

        c.AppendLine("      ""grounded"": " & occ.Grounded.ToString().ToLower() & ",")
        c.AppendLine("      ""suppressed"": " & occ.Suppressed.ToString().ToLower())

        c.Append("    }")
        compJson.Add(c.ToString())

    Next

    sb.AppendLine(String.Join("," & vbCrLf, compJson))
    sb.AppendLine("  ],")

    ' ======================================================
    ' 5. CONSTRAINTS
    ' ======================================================
    sb.AppendLine("  ""constraints"": [")
    Dim conJson As New List(Of String)

    For Each con As AssemblyConstraint In oDef.Constraints
        If con.Suppressed Then Continue For

        Dim typeStr As String = "Other"
        Dim offsetMm As String = "null"
        Dim angleDeg As String = "null"

        If con.[Type] = ObjectTypeEnum.kMateConstraintObject Then
            typeStr = "Mate"
            Dim mc As MateConstraint = CType(con, MateConstraint)
            Try : offsetMm = F(mc.Offset.Value * 10) : Catch : End Try

        ElseIf con.[Type] = ObjectTypeEnum.kFlushConstraintObject Then
            typeStr = "Flush"
            Dim fc As FlushConstraint = CType(con, FlushConstraint)
            Try : offsetMm = F(fc.Offset.Value * 10) : Catch : End Try

        ElseIf con.[Type] = ObjectTypeEnum.kInsertConstraintObject Then
            typeStr = "Insert"
            Dim ic As InsertConstraint = CType(con, InsertConstraint)
            Try : offsetMm = F(ic.Distance.Value * 10) : Catch : End Try

        ElseIf con.[Type] = ObjectTypeEnum.kAngleConstraintObject Then
            typeStr = "Angle"
            Dim ac As AngleConstraint = CType(con, AngleConstraint)
            Try : angleDeg = F(ac.Angle.Value * 180 / Math.PI) : Catch : End Try
        End If

        Dim cj As New StringBuilder()
        cj.AppendLine("    {")
        cj.AppendLine("      ""constraint_type"": """ & typeStr & """,")
        cj.AppendLine("      ""occurrence_1"": """ & EscapeJson(con.OccurrenceOne.Name) & """,")
        cj.AppendLine("      ""occurrence_2"": """ & EscapeJson(con.OccurrenceTwo.Name) & """,")
        cj.AppendLine("      ""offset_mm"": " & offsetMm & ",")
        cj.AppendLine("      ""angle_deg"": " & angleDeg)
        cj.Append("    }")

        conJson.Add(cj.ToString())
    Next

    sb.AppendLine(String.Join("," & vbCrLf, conJson))
    sb.AppendLine("  ]")

    ' ======================================================
    ' END JSON
    ' ======================================================
    sb.AppendLine("}")

    ' ======================================================
    ' WRITE FILE
    ' ======================================================
    Dim outPath As String = Path.ChangeExtension(oAsmDoc.FullFileName, "json")
    File.WriteAllText(outPath, sb.ToString())

    MessageBox.Show("âœ… Assembly JSON exported:" & vbCrLf & outPath)

End Sub

' ======================================================
' HELPERS
' ======================================================
Function F(v As Double) As String
    Return v.ToString(CultureInfo.InvariantCulture)
End Function

Function EscapeJson(s As String) As String
    If s Is Nothing Then Return ""
    Return s.Replace("\", "\\").Replace("""", "\""")
End Function

Function GetProp(doc As Document, setName As String, propName As String) As String
    Try
        Return doc.PropertySets.Item(setName).Item(propName).Value.ToString()
    Catch
        Return ""
    End Try
End Function