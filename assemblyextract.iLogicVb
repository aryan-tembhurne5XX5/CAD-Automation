Sub Main()
    If ThisApplication.ActiveDocument.DocumentType <> kAssemblyDocumentObject Then
        MessageBox.Show("Please open an assembly document.", "Error")
        Exit Sub
    End If

    Dim oAsmDoc As AssemblyDocument = ThisApplication.ActiveDocument
    Dim oAsmDef As AssemblyComponentDefinition = oAsmDoc.ComponentDefinition
    Dim oTG As TransientGeometry = ThisApplication.TransientGeometry

    ' Assembly metadata
    Dim assemblyData As New Dictionary(Of String, Object) From {
        {"assembly_name", oAsmDoc.DisplayName.Replace(".iam", "")},
        {"full_path", oAsmDoc.FullFileName},
        {"units", "mm"},
        {"mass_kg", oAsmDoc.ComponentDefinition.MassProperties.Mass / 1.0}, ' g to kg
        {"created_on", oAsmDoc.CreatedDateTime.ToString("yyyy-MM-dd HH:mm:ss")},
        {"author", oAsmDoc.PropertySets.Item("Design Tracking Properties").Item("Author").Value}
    }

    ' Root coordinate system - assembly origin
    Dim rootCS As New Dictionary(Of String, Object) From {
        {"origin_mm", New Dictionary(Of String, Double) From {{"x", 0}, {"y", 0}, {"z", 0}}},
        {"x_axis", New Dictionary(Of String, Double) From {{"x", 1}, {"y", 0}, {"z", 0}}},
        {"y_axis", New Dictionary(Of String, Double) From {{"x", 0}, {"y", 1}, {"z", 0}}},
        {"z_axis", New Dictionary(Of String, Double) From {{"x", 0}, {"y", 0}, {"z", 1}}}
    }

    ' Components
    Dim components As New List(Of Object)
    For Each oOcc As ComponentOccurrence In oAsmDef.Occurrences
        Dim transform As Matrix = oOcc.Transformation
        Dim trans As Dictionary(Of String, Double) = New Dictionary(Of String, Double) From {
            {"x", transform.Cell(0,3) * 10}, ' cm to mm
            {"y", transform.Cell(1,3) * 10},
            {"z", transform.Cell(2,3) * 10}
        }
        Dim rot As Object = New Object(2) {} ' 3x3 array
        For i = 0 To 2
            rot(i) = New Object(2) {}
            For j = 0 To 2
                rot(i)(j) = transform.Cell(i, j)
            Next
        Next

        Dim comp As New Dictionary(Of String, Object) From {
            {"occurrence_name", oOcc.Name},
            {"part_number", oOcc.Definition.Document.PropertySets("Design Tracking Properties")("Part Number").Value},
            {"file_name", oOcc.Definition.Document.DisplayName},
            {"transform", New Dictionary(Of String, Object) From {
                {"translation_mm", trans},
                {"rotation_matrix", rot}
            }},
            {"grounded", oOcc.Grounded},
            {"suppressed", oOcc.Suppressed},
            {"instance_index", If(oOcc.InstanceCount > 1, oOcc.InstanceId, 0)},
            {"pattern_parent", Nothing} ' Simplified, check parent if pattern
        }
        components.Add(comp)
    Next

    ' Constraints - simplified
    Dim constraints As New List(Of Object)
    For Each oConst As AssemblyConstraint In oAsmDef.Constraints
        Dim c1 As New Dictionary(Of String, Object) From {
            {"occurrence", oConst.EntityOne.Parent.Name},
            {"connection_point_id", Nothing},
            {"entity_type", "Face"} ' Simplified
        }
        Dim c2 As New Dictionary(Of String, Object) From {
            {"occurrence", oConst.EntityTwo.Parent.Name},
            {"connection_point_id", Nothing},
            {"entity_type", "Face"}
        }
        Dim cons As New Dictionary(Of String, Object) From {
            {"constraint_id", oConst.Name},
            {"constraint_type", oConst.Type.ToString()},
            {"component_1", c1},
            {"component_2", c2},
            {"parameters", New Dictionary(Of String, Object) From {
                {"offset_mm", If(oConst.Offset.Value, 0#)},
                {"angle_deg", If(oConst.Angle.Value, 0#)},
                {"flip", oConst.FlipEnabled}
            }},
            {"confidence", 1.0}
        }
        constraints.Add(cons)
    Next

    ' Fasteners - placeholder, would need Content Center or custom detection
    Dim fasteners As New List(Of Object)

    ' Patterns - simplified for rectangular
    Dim patterns As New List(Of Object)
    For Each oPat As OccurrencePattern In oAsmDef.OccurrencePatterns
        If oPat.Type = PatternTypeEnum.kRectangularPatternType Then
            Dim seedOcc As ComponentOccurrence = oPat.Parents.Item(1)
            Dim pat As New Dictionary(Of String, Object) From {
                {"pattern_name", oPat.Name},
                {"pattern_type", "Rectangular"},
                {"seed_component", seedOcc.Name},
                {"count", oPat.TotalOccurrences},
                {"direction_1", New Dictionary(Of String, Object) From {
                    {"vector", New Dictionary(Of String, Double) From {{"x", 1}, {"y", 0}, {"z", 0}}},
                    {"spacing_mm", oPat.Spacing(1) * 10}
                }},
                {"direction_2", New Dictionary(Of String, Object) From {
                    {"vector", New Dictionary(Of String, Double) From {{"x", 0}, {"y", 1}, {"z", 0}}},
                    {"spacing_mm", oPat.Spacing(2) * 10}
                }}
            }
            patterns.Add(pat)
        End If
    Next

    ' Assembly graph - simplified
    Dim graph As New Dictionary(Of String, Object) From {
        {"nodes", New List(Of Object) From {New Dictionary(Of String, Object) From {{"occurrence", "root"}, {"type", "Assembly"}}}},
        {"edges", New List(Of Object)}
    }

    ' Full JSON structure
    Dim jsonData As New Dictionary(Of String, Object) From {
        {"assembly_metadata", assemblyData},
        {"root_coordinate_system", rootCS},
        {"components", components},
        {"constraints", constraints},
        {"fasteners", fasteners},
        {"patterns", patterns},
        {"assembly_graph", graph}
    }

    ' Serialize to JSON - using Newtonsoft.Json (add reference if needed) or simple string builder
    ' For iLogic, use ThisApplication.WriteObjectToFile or external
    Dim jsonStr As String = Newtonsoft.Json.JsonConvert.SerializeObject(jsonData, Newtonsoft.Json.Formatting.Indented)
    ThisApplication.WriteObjectToFile(jsonStr, ThisApplication.CADPath & "\assembly_schema.json") ' Save to temp

    MessageBox.Show("JSON exported to: " & ThisApplication.CADPath & "\assembly_schema.json", "Success")
End Sub
