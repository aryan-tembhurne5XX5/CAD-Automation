' ==========================================================
' COMPLETE ASSEMBLY EXTRACTION WITH TRANSFORMS + CONSTRAINTS
' ==========================================================

Imports System
Imports System.IO
Imports System.Text
Imports System.Web.Script.Serialization

Dim asmDoc As AssemblyDocument = ThisApplication.ActiveDocument
Dim asmDef As AssemblyComponentDefinition = asmDoc.ComponentDefinition
Dim refKeyMgr As ReferenceKeyManager = asmDoc.ReferenceKeyManager

Dim exportData As New Dictionary(Of String, Object)

' ==========================================================
' 1️⃣ Assembly Metadata
' ==========================================================

Dim meta As New Dictionary(Of String, Object)
meta("assembly_name") = asmDoc.DisplayName
meta("internal_name") = asmDoc.InternalName
meta("units") = asmDoc.UnitsOfMeasure.LengthUnits
meta("total_occurrences") = asmDef.Occurrences.Count
meta("total_constraints") = asmDef.Constraints.Count
exportData("assembly_metadata") = meta

' ==========================================================
' 2️⃣ Extract Component Transforms (TRUE MATRIX)
' ==========================================================

Dim components As New List(Of Object)

For Each occ As ComponentOccurrence In asmDef.Occurrences
    
    Dim comp As New Dictionary(Of String, Object)
    
    comp("occurrence_name") = occ.Name
    comp("file_name") = occ.Definition.Document.DisplayName
    comp("internal_name") = occ.Definition.Document.InternalName
    comp("grounded") = occ.Grounded
    
    ' TRUE transform matrix
    Dim m As Matrix = occ.Transformation
    
    Dim rot(2)() As Double
    For i = 0 To 2
        rot(i) = New Double(2) {}
        For j = 0 To 2
            rot(i)(j) = m.Cell(i+1, j+1)
        Next
    Next
    
    Dim trans As New Dictionary(Of String, Object)
    trans("rotation_matrix") = rot
    trans("translation_cm") = New Double() {m.Cell(1,4), m.Cell(2,4), m.Cell(3,4)}
    
    comp("transform") = trans
    
    components.Add(comp)
    
Next

exportData("components") = components

' ==========================================================
' 3️⃣ Extract Constraints WITH Reference Keys
' ==========================================================

Dim constraints As New List(Of Object)

For Each c As AssemblyConstraint In asmDef.Constraints
    
    Dim con As New Dictionary(Of String, Object)
    
    con("constraint_type") = c.Type.ToString()
    con("constraint_id") = c.Name
    
    con("occurrence_one") = c.OccurrenceOne.Name
    con("occurrence_two") = c.OccurrenceTwo.Name
    
    ' ===== Reference Keys =====
    Dim key1() As Byte = Nothing
    Dim key2() As Byte = Nothing
    
    c.EntityOne.GetReferenceKey(key1)
    c.EntityTwo.GetReferenceKey(key2)
    
    Dim context() As Byte = Nothing
    refKeyMgr.GetKeyContext(context)
    
    con("entity_one_key") = Convert.ToBase64String(key1)
    con("entity_two_key") = Convert.ToBase64String(key2)
    con("reference_context") = Convert.ToBase64String(context)
    
    ' ===== Parameters =====
    Dim params As New Dictionary(Of String, Object)
    
    If TypeOf c Is MateConstraint Then
        params("offset_cm") = CType(c, MateConstraint).Offset.Value
    ElseIf TypeOf c Is FlushConstraint Then
        params("offset_cm") = CType(c, FlushConstraint).Offset.Value
    ElseIf TypeOf c Is AngleConstraint Then
        params("angle_rad") = CType(c, AngleConstraint).Angle.Value
    End If
    
    con("parameters") = params
    
    constraints.Add(con)
    
Next

exportData("constraints") = constraints

' ==========================================================
' 4️⃣ Write JSON File
' ==========================================================

Dim serializer As New JavaScriptSerializer()
serializer.MaxJsonLength = Integer.MaxValue

Dim json As String = serializer.Serialize(exportData)

Dim path As String = System.IO.Path.Combine( _
    System.Environment.GetFolderPath(Environment.SpecialFolder.Desktop), _
    asmDoc.DisplayName & "_FULL_EXPORT.json")

System.IO.File.WriteAllText(path, json)

MessageBox.Show("Export complete:" & vbCrLf & path)